#![feature(static_in_const)]

extern crate tempdir;

use std::mem;
use std::io::Write;
use std::process::{Command, Stdio};
use std::env;
use std::fs::File;

use tempdir::TempDir;

fn main() {
    let gcc = format!("{}-gcc", env::args().nth(1).unwrap());
    let _td = TempDir::new("sc-gen").unwrap();
    let td = &_td.path().to_owned();
    mem::forget(_td);

    println!("/* Automatically generated by sc-gen {} */\n",
             env!("CARGO_PKG_VERSION"));
    for syscall in SYSCALLS {
        write!(File::create(td.join("syscall.c")).unwrap(),
               "
#include <stdio.h>
#define _GNU_SOURCE
#include <unistd.h>
#include <sys/syscall.h>

int main() {{
  printf(\"%d\\n\", {});

  return 0;
}}
",
               syscall)
            .unwrap();

        let status = Command::new(&gcc)
            .arg("syscall.c")
            .current_dir(td)
            .stderr(Stdio::null())
            .status()
            .unwrap();

        let name = syscall[5..].to_uppercase();
        if status.success() {
            let output = Command::new(td.join("a.out")).output().unwrap();

            assert!(output.status.success());
            let nr = String::from_utf8(output.stdout).unwrap();
            println!("pub const {}: usize = {};", name, nr.trim());
        } else {
            println!("// pub const {}: usize = {};", name, syscall);
        }

    }

}

const SYSCALLS: &[&str] = &["__NR__llseek",
                            "__NR__newselect",
                            "__NR__sysctl",
                            "__NR_accept",
                            "__NR_accept4",
                            "__NR_access",
                            "__NR_acct",
                            "__NR_add_key",
                            "__NR_adjtimex",
                            "__NR_alarm",
                            "__NR_arm_fadvise64_64",
                            "__NR_arm_sync_file_range",
                            "__NR_bdflush",
                            "__NR_bind",
                            "__NR_brk",
                            "__NR_capget",
                            "__NR_capset",
                            "__NR_chdir",
                            "__NR_chmod",
                            "__NR_chown",
                            "__NR_chown32",
                            "__NR_chroot",
                            "__NR_clock_adjtime",
                            "__NR_clock_getres",
                            "__NR_clock_gettime",
                            "__NR_clock_nanosleep",
                            "__NR_clock_settime",
                            "__NR_clone",
                            "__NR_close",
                            "__NR_connect",
                            "__NR_creat",
                            "__NR_delete_module",
                            "__NR_dup",
                            "__NR_dup2",
                            "__NR_dup3",
                            "__NR_epoll_create",
                            "__NR_epoll_create1",
                            "__NR_epoll_ctl",
                            "__NR_epoll_pwait",
                            "__NR_epoll_wait",
                            "__NR_eventfd",
                            "__NR_eventfd2",
                            "__NR_execve",
                            "__NR_exit",
                            "__NR_exit_group",
                            "__NR_faccessat",
                            "__NR_fallocate",
                            "__NR_fanotify_init",
                            "__NR_fanotify_mark",
                            "__NR_fchdir",
                            "__NR_fchmod",
                            "__NR_fchmodat",
                            "__NR_fchown",
                            "__NR_fchown32",
                            "__NR_fchownat",
                            "__NR_fcntl",
                            "__NR_fcntl64",
                            "__NR_fdatasync",
                            "__NR_fgetxattr",
                            "__NR_finit_module",
                            "__NR_flistxattr",
                            "__NR_flock",
                            "__NR_fork",
                            "__NR_fremovexattr",
                            "__NR_fsetxattr",
                            "__NR_fstat",
                            "__NR_fstat64",
                            "__NR_fstatat64",
                            "__NR_fstatfs",
                            "__NR_fstatfs64",
                            "__NR_fsync",
                            "__NR_ftruncate",
                            "__NR_ftruncate64",
                            "__NR_futex",
                            "__NR_futimesat",
                            "__NR_get_mempolicy",
                            "__NR_get_robust_list",
                            "__NR_getcpu",
                            "__NR_getcwd",
                            "__NR_getdents",
                            "__NR_getdents64",
                            "__NR_getegid",
                            "__NR_getegid32",
                            "__NR_geteuid",
                            "__NR_geteuid32",
                            "__NR_getgid",
                            "__NR_getgid32",
                            "__NR_getgroups",
                            "__NR_getgroups32",
                            "__NR_getitimer",
                            "__NR_getpeername",
                            "__NR_getpgid",
                            "__NR_getpgrp",
                            "__NR_getpid",
                            "__NR_getppid",
                            "__NR_getpriority",
                            "__NR_getresgid",
                            "__NR_getresgid32",
                            "__NR_getresuid",
                            "__NR_getresuid32",
                            "__NR_getrlimit",
                            "__NR_getrusage",
                            "__NR_getsid",
                            "__NR_getsockname",
                            "__NR_getsockopt",
                            "__NR_gettid",
                            "__NR_gettimeofday",
                            "__NR_getuid",
                            "__NR_getuid32",
                            "__NR_getxattr",
                            "__NR_init_module",
                            "__NR_inotify_add_watch",
                            "__NR_inotify_init",
                            "__NR_inotify_init1",
                            "__NR_inotify_rm_watch",
                            "__NR_io_cancel",
                            "__NR_io_destroy",
                            "__NR_io_getevents",
                            "__NR_io_setup",
                            "__NR_io_submit",
                            "__NR_ioctl",
                            "__NR_ioprio_get",
                            "__NR_ioprio_set",
                            "__NR_ipc",
                            "__NR_kcmp",
                            "__NR_kexec_load",
                            "__NR_keyctl",
                            "__NR_kill",
                            "__NR_lchown",
                            "__NR_lchown32",
                            "__NR_lgetxattr",
                            "__NR_link",
                            "__NR_linkat",
                            "__NR_listen",
                            "__NR_listxattr",
                            "__NR_llistxattr",
                            "__NR_lookup_dcookie",
                            "__NR_lremovexattr",
                            "__NR_lseek",
                            "__NR_lsetxattr",
                            "__NR_lstat",
                            "__NR_lstat64",
                            "__NR_madvise",
                            "__NR_mbind",
                            "__NR_mincore",
                            "__NR_mkdir",
                            "__NR_mkdirat",
                            "__NR_mknod",
                            "__NR_mknodat",
                            "__NR_mlock",
                            "__NR_mlockall",
                            "__NR_mmap",
                            "__NR_mmap2",
                            "__NR_mount",
                            "__NR_move_pages",
                            "__NR_mprotect",
                            "__NR_mq_getsetattr",
                            "__NR_mq_notify",
                            "__NR_mq_open",
                            "__NR_mq_timedreceive",
                            "__NR_mq_timedsend",
                            "__NR_mq_unlink",
                            "__NR_mremap",
                            "__NR_msgctl",
                            "__NR_msgget",
                            "__NR_msgrcv",
                            "__NR_msgsnd",
                            "__NR_msync",
                            "__NR_munlock",
                            "__NR_munlockall",
                            "__NR_munmap",
                            "__NR_name_to_handle_at",
                            "__NR_nanosleep",
                            "__NR_nfsservctl",
                            "__NR_nice",
                            "__NR_open",
                            "__NR_open_by_handle_at",
                            "__NR_openat",
                            "__NR_pause",
                            "__NR_pciconfig_iobase",
                            "__NR_pciconfig_read",
                            "__NR_pciconfig_write",
                            "__NR_perf_event_open",
                            "__NR_personality",
                            "__NR_pipe",
                            "__NR_pipe2",
                            "__NR_pivot_root",
                            "__NR_poll",
                            "__NR_ppoll",
                            "__NR_prctl",
                            "__NR_pread64",
                            "__NR_preadv",
                            "__NR_prlimit64",
                            "__NR_process_vm_readv",
                            "__NR_process_vm_writev",
                            "__NR_pselect6",
                            "__NR_ptrace",
                            "__NR_pwrite64",
                            "__NR_pwritev",
                            "__NR_quotactl",
                            "__NR_read",
                            "__NR_readahead",
                            "__NR_readdir",
                            "__NR_readlink",
                            "__NR_readlinkat",
                            "__NR_readv",
                            "__NR_reboot",
                            "__NR_recv",
                            "__NR_recvfrom",
                            "__NR_recvmmsg",
                            "__NR_recvmsg",
                            "__NR_remap_file_pages",
                            "__NR_removexattr",
                            "__NR_rename",
                            "__NR_renameat",
                            "__NR_request_key",
                            "__NR_restart_syscall",
                            "__NR_rmdir",
                            "__NR_rt_sigaction",
                            "__NR_rt_sigpending",
                            "__NR_rt_sigprocmask",
                            "__NR_rt_sigqueueinfo",
                            "__NR_rt_sigreturn",
                            "__NR_rt_sigsuspend",
                            "__NR_rt_sigtimedwait",
                            "__NR_rt_tgsigqueueinfo",
                            "__NR_sched_get_priority_max",
                            "__NR_sched_get_priority_min",
                            "__NR_sched_getaffinity",
                            "__NR_sched_getparam",
                            "__NR_sched_getscheduler",
                            "__NR_sched_rr_get_interval",
                            "__NR_sched_setaffinity",
                            "__NR_sched_setparam",
                            "__NR_sched_setscheduler",
                            "__NR_sched_yield",
                            "__NR_select",
                            "__NR_semctl",
                            "__NR_semget",
                            "__NR_semop",
                            "__NR_semtimedop",
                            "__NR_send",
                            "__NR_sendfile",
                            "__NR_sendfile64",
                            "__NR_sendmmsg",
                            "__NR_sendmsg",
                            "__NR_sendto",
                            "__NR_set_mempolicy",
                            "__NR_set_robust_list",
                            "__NR_set_tid_address",
                            "__NR_setdomainname",
                            "__NR_setfsgid",
                            "__NR_setfsgid32",
                            "__NR_setfsuid",
                            "__NR_setfsuid32",
                            "__NR_setgid",
                            "__NR_setgid32",
                            "__NR_setgroups",
                            "__NR_setgroups32",
                            "__NR_sethostname",
                            "__NR_setitimer",
                            "__NR_setns",
                            "__NR_setpgid",
                            "__NR_setpriority",
                            "__NR_setregid",
                            "__NR_setregid32",
                            "__NR_setresgid",
                            "__NR_setresgid32",
                            "__NR_setresuid",
                            "__NR_setresuid32",
                            "__NR_setreuid",
                            "__NR_setreuid32",
                            "__NR_setrlimit",
                            "__NR_setsid",
                            "__NR_setsockopt",
                            "__NR_settimeofday",
                            "__NR_setuid",
                            "__NR_setuid32",
                            "__NR_setxattr",
                            "__NR_shmat",
                            "__NR_shmctl",
                            "__NR_shmdt",
                            "__NR_shmget",
                            "__NR_shutdown",
                            "__NR_sigaction",
                            "__NR_sigaltstack",
                            "__NR_signalfd",
                            "__NR_signalfd4",
                            "__NR_sigpending",
                            "__NR_sigprocmask",
                            "__NR_sigreturn",
                            "__NR_sigsuspend",
                            "__NR_socket",
                            "__NR_socketcall",
                            "__NR_socketpair",
                            "__NR_splice",
                            "__NR_stat",
                            "__NR_stat64",
                            "__NR_statfs",
                            "__NR_statfs64",
                            "__NR_stime",
                            "__NR_swapoff",
                            "__NR_swapon",
                            "__NR_symlink",
                            "__NR_symlinkat",
                            "__NR_sync",
                            "__NR_sync_file_range2",
                            "__NR_syncfs",
                            "__NR_syscall",
                            "__NR_sysfs",
                            "__NR_sysinfo",
                            "__NR_syslog",
                            "__NR_tee",
                            "__NR_tgkill",
                            "__NR_time",
                            "__NR_timer_create",
                            "__NR_timer_delete",
                            "__NR_timer_getoverrun",
                            "__NR_timer_gettime",
                            "__NR_timer_settime",
                            "__NR_timerfd_create",
                            "__NR_timerfd_gettime",
                            "__NR_timerfd_settime",
                            "__NR_times",
                            "__NR_tkill",
                            "__NR_truncate",
                            "__NR_truncate64",
                            "__NR_ugetrlimit",
                            "__NR_umask",
                            "__NR_umount",
                            "__NR_umount2",
                            "__NR_uname",
                            "__NR_unlink",
                            "__NR_unlinkat",
                            "__NR_unshare",
                            "__NR_uselib",
                            "__NR_ustat",
                            "__NR_utime",
                            "__NR_utimensat",
                            "__NR_utimes",
                            "__NR_vfork",
                            "__NR_vhangup",
                            "__NR_vmsplice",
                            "__NR_vserver",
                            "__NR_wait4",
                            "__NR_waitid",
                            "__NR_write",
                            "__NR_writev"];
